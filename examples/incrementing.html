<html>
	<input type="file" accept="audio" id="input"/>
	<button id="play">Feed 1 second of audio</button>

	<script src="https://cdn.jsdelivr.net/npm/wavefile"></script>
	<script src="../dist/feeder-node.js"></script>
	<script>
		var input = document.getElementById('input');
		var play = document.getElementById('play');
		let samples, feederNode, nChannels, sampleRate;
		let initialized = false;

		// load a .wav file
		var reader = new FileReader();
		reader.onload = function(e) {
			let safariFixed = e.target.result.split('base64,')[1];

			var wav = new wavefile.WaveFile();

			wav.fromBase64(safariFixed);

			nChannels = wav.fmt.numChannels;
			sampleRate = wav.fmt.sampleRate;
			
			samples = new Float32Array(200000);

			let incrementer = 0;
			for (let i = 0; i < samples.length; i++) {
				samples[i] = incrementer++;
				if (incrementer === 9999) incrementer = 0;
			}
		}
		input.onchange = (e) => {
			reader.readAsDataURL(e.target.files[0]);
		}

		let offset = 0;
		play.onclick = () => {
			if (!initialized) init();
			initialized = true;

			startAudioInterval();
		}

		function init() {
			let AudioCtx = window.AudioContext || window.webkitAudioContext;
			let context = new AudioCtx({sampleRate: 44100});
			feederNode = new FeederNode(context, {
				pathToWorkletProcessor: '/dist/feeder-node.processor.js', 
				pathToWorker: '/dist/feeder-node.worker.js', 
				nChannels: nChannels,
				inputSampleRate: sampleRate,
				outputSampleRate: context.sampleRate,
			});
			feederNode.connect(context.destination);
		}

		// every second, feed 1 second (or remaining amount) of audio data
		function startAudioInterval() {

			setInterval(() => {
				let chunkSize = 44100 * 2 / 10;
				let dataAvailable = samples.length - offset;

				chunkSize = Math.min(chunkSize, dataAvailable);

				if (chunkSize <= 0) return;

				let data = new Float32Array(chunkSize);

				for (let i = 0; i < chunkSize; i++) {
					data[i] = samples[offset + i];
				}

				feederNode.feed(data);

				offset += chunkSize; // underlying buffer in WaveFile is float64
			}, 100);
		}
	</script>
</html>